@model int
@{
    ViewBag.Title = "ClassEvaluation";
    Layout = "~/Views/Shared/_MasterLayout.cshtml";
}

<!-- Page Content -->
<div class="content container-fluid">

    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h3 class="page-title">Danh sách đánh giá rèn luyện</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                    <li class="breadcrumb-item active">Danh sách đánh giá rèn luyện</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- /Page Header -->
    <!-- Search Filter -->
    <div class="row filter-row">
        <!--Render list semesters-->
        @Html.Action("ListSemester", "UnionEvaluation")
        <!--Form Status-->
        <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
            <div class="form-group form-focus select-focus">
                <select class="select floating" id="select-status">
                    <option value="-1"> -- Tất cả -- </option>
                    <option value="1">Đã đánh giá</option>
                    <option value="0">Chưa đánh giá</option>
                </select>
                <label class="focus-label">Đã/ chưa đánh giá</label>
            </div>
        </div>
        <!--Form Condition-->
        <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
            <div class="form-group form-focus select-focus">
                <select class="select floating" id="select-situation">
                    <option value=""> -- Tất cả -- </option>
                    <option value="Chờ Chấm"> Đợi chấm </option>
                    <option value="Chờ Lớp"> Chờ lớp </option>
                    <option value="Chờ Duyệt"> Chờ duyệt </option>
                    <option value="Chờ Khoa"> Chờ Khoa </option>
                    <option value="Hoàn Thành"> Hoàn thành </option>
                </select>
                <label class="focus-label">Tình trạng</label>
            </div>
        </div>
        <!--Search by ID or Name-->
        <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
            <div class="form-group form-focus">
                <input type="text" class="form-control floating" id="search-string">
                <label class="focus-label">MSSV/Tên đoàn viên</label>
            </div>
        </div>
        <div class="col-sm-6 col-md-3 col-lg-3 col-xl-2 col-12">
            <a href="#" class="btn btn-secondary btn-block" id="btn-search"> Tìm kiếm </a>
        </div>
    </div>
    <!-- /Search Filter -->

    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table id="myTable" class="table table-bordered table-striped custom-table mb-0 datatable text-center"
                       style="width:100%; font-size: 13px;">
                    <thead>
                        <tr style="box-shadow:none">
                            <th rowspan="2">
                                <span>
                                    STT
                                </span>
                            </th>
                            <th rowspan="2">
                                <span>
                                    MSSV
                                </span>
                            </th>
                            <th rowspan="2">
                                <span>
                                    Họ và tên
                                </span>
                            </th>
                            <th rowspan="2">
                                <span>
                                    Ngày sinh
                                </span>
                            </th>
                            <th colspan="4">Điểm</th>
                            <th rowspan="2">
                                <span>
                                    Xếp loại
                                </span>
                            </th>
                            <th rowspan="2">
                                <span>
                                    Tình trạng
                                </span>
                            </th>
                            <th rowspan="2">
                                <span>
                                    Tác vụ
                                </span>
                            </th>
                            <th rowspan="2">
                                <span>
                                    Ghi chú
                                </span>
                            </th>
                        </tr>
                        <tr style="box-shadow:none">
                            <th>ĐV</th>
                            <th>Lớp</th>
                            <th>Khoa</th>
                            <th>Trường</th>
                        </tr>
                    </thead>

                </table>
            </div>
        </div>
    </div>
</div>
<!-- /Page Content -->
<!-- Add note Modal -->
@*<div id="addnote_modal" class="modal custom-modal fade" data-backdrop="static" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm ghi chú</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label>Nội dung ghi chú<span class="text-danger">*</span></label>
                                <textarea class="form-control" rows="10"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="submit-section">
                        <button class="btn btn-primary submit-btn">Thêm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>*@
<!-- /Add note Modal -->
<!-- View note Modal -->
@*<div id="viewnote_modal" class="modal custom-modal fade" data-backdrop="static" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xem/ Sửa ghi chú</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">

                        <div class="col-sm-12">
                            <div class="form-group">
                                <label>Nội dung ghi chú <span class="text-danger">*</span></label>
                                <textarea class="form-control" rows="10">Chúc bạn 1 ngày tốt lành</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="submit-section m-t-10 d-flex justify-content-around">
                        <button class="btn btn-outline-danger submit-btn">Xóa ghi chú</button>
                        <button class="btn btn-primary submit-btn">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>*@
<!-- /View note Modal -->
@section js{
    <script src="~/Assets/js/jquery.dataTables.min.js"></script>
    <script src="~/Assets/js/dataTables.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function () {
            var table = $("#myTable").DataTable({
                searching: false,
                ordering: false,
                responsive: true,
                processing: true,
                columns: [
                    {
                        "render": function (data, type, full, meta) {
                            return meta.row + 1;
                        },
                        "class": "text-center"
                    },
                    { "data": "StudentCode", "class": "text-center" },
                    { "data": "FullName"},
                    { "data": "BirthDate"},
                    {
                        "data": "Score1",
                        "render": function (data) {
                            if (data == null) {
                                return "-"
                            }
                            else {
                                return data
                            }
                        }
                    },
                    {
                        "data": "Score2",
                        "render": function (data) {
                            if (data == null) {
                                return "-"
                            }
                            else {
                                return data
                            }
                        }
                    },
                    {
                        "data": "Score3",
                        "render": function (data) {
                            if (data == null) {
                                return "-"
                            }
                            else {
                                return data
                            }
                        }
                    },
                    {
                        "data": "Score4",
                        "render": function (data) {
                            if (data == null) {
                                return "-"
                            }
                            else {
                                return data
                            }
                        }
                    },
                    {
                        "data": "Ranking",
                        "render": function (data) {
                            if (data == null) {
                                return "-"
                            }
                            else
                            {
                                return data
                            }
                        }
                    },
                    {
                        "data": "Situation", "class": "text-center",
                        "render": function (data) {
                            if (data == "Hoàn Thành") {
                                return "<span class='badge bg-inverse-success text-sm'>" + data + "</span>"
                            }
                            else {
                                return "<span class='badge bg-inverse-warning text-sm'>" + data + "</span>"
                            }
                        }
                    },
                    {
                        "data": "formId",
                        "render": function (data) {
                            return "<a href='/UnionEvaluation/FormDetail/" + data + "'><i class='fa fa-eye fa-lg'></i></a>";
                        }
                    },
                    {
                        "data": "Note",
                        "render": function (data, type, row) {
                            if (data == null) {
                                return '<a href="#" data-toggle="modal" data-target="#addnote_modal_' + row['formId'] + '" title="Thêm ghi chú"> <i class="las la-comment-medical text-xl text-secondary juged-icon"></i> </a> <div id="addnote_modal_' + row['formId'] + '" class="modal custom-modal fade" data-backdrop="static" role="dialog"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Thêm ghi chú</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div><div class="modal-body"> <form class="form-note" data-id="' + row['formId'] + '"> <div class="row"> <div class="col-sm-12"> <div class="form-group"> <label>Nội dung ghi chú<span class="text-danger">*</span></label> <textarea id="form-textarea' + row['formId'] +'" class="form-control" spellcheck="false" rows="10"></textarea> </div></div></div><div class="submit-section"> <button type="submit" class="btn btn-primary submit-btn">Thêm</button> </div></form> </div></div></div></div>'
                            }
                            else {
                                return '<a href="#" data-toggle="modal" data-target="#viewnote_modal_' + row['formId'] + '" title="Xem/Sửa ghi chú"> <i class="las la-comment text-xl text-success juged-icon"></i> </a> <div id="viewnote_modal_' + row['formId'] + '" class="modal custom-modal fade" data-backdrop="static" role="dialog"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Xem/Sửa ghi chú</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div><div class="modal-body"> <form class="form-note" data-id="' + row['formId'] + '"> <div class="row"> <div class="col-sm-12"> <div class="form-group"> <label>Nội dung ghi chú <span class="text-danger">*</span></label> <textarea id="form-textarea' + row['formId'] + '" class="form-control" spellcheck="false" rows="10">' + data + '</textarea> </div></div></div><div class="submit-section m-t-10 d-flex justify-content-around"> <button id="btn-delete-modal" class="btn btn-outline-danger submit-btn">Xóa ghi chú</button> <button type="submit" class="btn btn-primary submit-btn">Lưu</button> </div></form> </div></div></div></div>';
                            }
                        }
                    },
                ],
                ajax: {
                    url: "/UnionEvaluation/GetClassEvaluation/?classId="+@Model
                }
            })
            $('#btn-search').on("click", function () {
                var semesterId = $('#select-semesterId').val();
                var status = $('#select-status').val();
                var situation = $('#select-situation').val();
                var searchString = $('#search-string').val();
                console.log("classId-" +@Model+", semesterId-" + semesterId + ", status-" + status + ", situation-" + situation + ", searchText-" + searchString)
                table.ajax.url("/UnionEvaluation/SearchClassEvaluation?classId=" +@Model+"&semesterId=" + semesterId + "&Status=" + status + "&situation=" + situation + "&searchText=" + searchString).load();  
            })


            $(document).on('submit','.form-note', function (e) {
                var formId = $(this).data('id');
                var updateNote = $('#form-textarea' + formId).val();
                UpdateNote(formId, updateNote).then(function (data) {
                    if (data)
                    {
                        toastr.success("Cập nhật ghi chú thành công!", "Thành công");
                        sound("/Assets/mp3/smallbox.mp3");
                        table.ajax.reload();
                        $('.close').click();
                    }
                    else
                    {
                        toastr.error("Đã có lỗi xảy ra. Vui lòng thử lại", "Thất bại");
                        sound("/Assets/mp3/error.mp3");
                    }
                })
                return false;
            })
            $(document).on('click', '#btn-delete-modal', function (e) {
                var formId = $('#btn-delete-modal').closest('form').data('id');
                UpdateNote(formId, null).then(function (data) {
                    if (data) {
                        toastr.success("Xóa ghi chú thành công!", "Thành công");
                        sound("/Assets/mp3/smallbox.mp3");
                        table.ajax.reload();
                        $('.close').click();
                    }
                    else {
                        toastr.error("Đã có lỗi xảy ra. Vui lòng thử lại", "Thất bại");
                        sound("/Assets/mp3/error.mp3");
                    }
                })
                return false;
            });

            var UpdateNote = function (formId, updateNote) {
                return new Promise(function (resolve) {
                    $.ajax({
                        url: "/UnionEvaluation/AddOrUpdateEvaluationFormNote/",
                        method: "post",
                        data: { formId: formId, updateNote: updateNote },
                        dataType: "json",
                        success: function (data) {
                            resolve(data)
                        }
                    })
                })
            }
        })
    </script>
}
